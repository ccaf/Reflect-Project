<!DOCTYPE html>
<html>
<head>
  <script src="../lib/mithril.js"></script>
  <script src="../lib/interact-1.2.4.js"></script>
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css" />
  <link rel="stylesheet" href="styles.css" />

  <script src="../shared/models.js"></script>
  <script src="../shared/polyfill.js"></script>

  <script src="controllers/ClassroomSelect.js"></script>
  <script src="controllers/App.js"></script>
  <script src="controllers/Home.js"></script>

  <script src="transform.js"></script>

  <script type="text/javascript">
    window.addEventListener('resize', m.redraw);

    window.onload = function() {
      var conn = window.conn = new WebSocket('ws://' + (typeof require === 'undefined' ? window.location.hostname : 'localhost') + ':904/');
      conn.sendObj = function(channel, message) {
        conn.send(JSON.stringify({'channel': channel, 'message': message}));
      };

      var actionHandler = {
        'event-client-updated': function(message) {
          m.startComputation();
          if (app.activeClassroom() && app.activeClassroom()._id() === message.classroom)
            Object.assign(app.activeClassroom().devices[app.activeClassroom().devices.map(function(device) { return device._id(); }).indexOf(message.device._id)], new DeviceModel(message.device));
          m.endComputation();
        },
        'event-server-disconnected': function() {
          setTimeout(function() {
            function checkStatus() {
              setTimeout(function() {
                var img;
                if ((img = document.getElementById('check')) == null) {
                  img = document.createElement('img');
                  img.style.display = 'none';
                  img.onerror = checkStatus;
                  img.onload = function() {
                    location.reload(true);
                  };
                }
                img.src = '../shared/up.png?' + Math.random();
                document.body.appendChild(img);
              }, 1000);
            }

            document.getElementById('container').innerHTML = '<center><h1>Server disconnected</h1></center>';
            checkStatus();
          }, 1000);
        },
        'ping': function() {
          conn.sendObj('pong');
        }
      };

      conn.onmessage = function(json) {
        var envelope = JSON.parse(json.data);
        if (envelope.channel in actionHandler) actionHandler[envelope.channel](envelope.message);
      };
      conn.onclose = function() {
        actionHandler['event-server-disconnected'];
      }

      m.route.mode = 'hash';

      var app = window.app = m.mount(document.getElementById('navigation'), App);
      app.addPage({'title': 'Select a classroom', 'href': '/', 'controller': ClassroomSelect});

      // the hackiest hack
      if (window.location.href.indexOf('#') == -1) window.location.href += '#';
      window.location.href = window.location.href.replace("/#", "/?#");
    };
  </script>
</head>
<body>

<div id="container" class="container-fluid">
  <div id="navigation"></div>
  <div id="page"></div>
</div>

</body>
</html>
