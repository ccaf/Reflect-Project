<!DOCTYPE html>
<html>
<head>
  <script src="../lib/mithril.js"></script>
  <script src="../shared/models.js"></script>
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    var App = {
      'controller': function(args) {
        args = args || {};

        var activeClassroom = m.prop(null);
        var activeDevice = m.prop(null);
        var state = m.prop(args.state || 'ClassroomSelect');

        var setActiveClassroom = function(classroom) {
          ClassroomModel.get(classroom).then(function(classroom) {
            activeClassroom(classroom);
            state('DeviceSelect');
          });
        };

        var setActiveDevice = function(index) {
          conn.sendObj('event-set-active', {'classroom': activeClassroom()._id, 'index': index});
        };

        return {
          'activeClassroom': activeClassroom,
          'activeDevice': activeDevice,
          'state': state,
          'setActiveClassroom': setActiveClassroom,
          'setActiveDevice': setActiveDevice
        }
      },
      'view': function(ctrl) {
        switch(ctrl.state()) {
          case 'ClassroomSelect':
            return m.component(ClassroomSelect);
          case 'DeviceSelect':
            return m.component(DeviceSelect);
        }
      }
    }

    var ClassroomSelect = {
      'controller': function(args) {
        return {
          'classrooms': ClassroomModel.get()
        };
      },
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a classroom']),
              m('div.list-group', [
                ctrl.classrooms().map(function(classroom) {
                  return m('a.list-group-item', {'onclick': function(e) { app.setActiveClassroom(classroom); }}, [classroom.name()])
                })
              ])
            ])
          ])
        );
      }
    };

    var DeviceSelect = {
      'controller': function(args) {
        return {
          'devices': m.prop(app.activeClassroom().devices)
        };
      },
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a device']),
              m('div.list-group', [
                ctrl.devices().map(function(device, index) {
                  return m('a.list-group-item', {'onclick': function(e) { app.setActiveDevice(index); }}, [device.name()])
                })
              ])
            ])
          ])
        );      }
    }

    window.onload = function(e) {
      var conn = window.conn = new WebSocket('ws://' + window.location.hostname + ':905/');
      conn.sendObj = function(channel, message) {
        conn.send(JSON.stringify({'channel': channel, 'message': message}));
      };

      var actionHandler = {
        'event-acknowledge-active': function(message) {
          app.state('Connected');
        }
      };

      conn.onmessage = function(json) {
        var message = JSON.parse(json.data);
        if (message.channel in actionHandler) actionHandler[message.channel](message);
      };

      var app = window.app = m.mount(document.getElementById('app'), App);
    }
  </script>
</head>
<body>
<div class="container-fluid" id="app"></div>
</body>
</html>
