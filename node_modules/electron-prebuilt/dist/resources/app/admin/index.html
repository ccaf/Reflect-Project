<!DOCTYPE html>
<html>
<head>
  <script src="../lib/mithril.js"></script>
  <script src="../lib/interact-1.2.4.js"></script>
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    /*
    TODO
    - create stylesheet and remove as many (all?) styles as possible from source

    */
    var urlBase = (typeof require === 'undefined' ? window.location.origin + '/api' : 'http://localhost:1867/api');

    function updateTransform(target) {
      var x = (parseFloat(target.getAttribute('data-x')) || 0);
      var y = (parseFloat(target.getAttribute('data-y')) || 0);
      var scale = parseFloat(target.getAttribute('data-scale')) || 1;
      var angle = parseFloat(target.getAttribute('data-angle')) || 0;

      target.style.webkitTransform =
      target.style.transform =
      'translate(' + x + 'px, ' + y + 'px) scale(' + scale + ') rotate(' + angle + 'deg)';
    }

    interact('.interact')
    .draggable({
      'restrict': {
        'restriction': 'parent'
      },
      onmove: function (event) {

        x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.dx;
        y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.dy;

        // update the posiion attributes
        event.target.setAttribute('data-x', x);
        event.target.setAttribute('data-y', y);

        updateTransform(event.target);
      }
    });

    function regrid() {
      m.redraw();
    }

    window.addEventListener('resize', regrid);

    var ClassroomModel = function(args) {
      args = args || {},
        args.devices = args.devices || [],
        args.accentWall = args.accentWall || {},
        args.dimensions = args.dimensions || {};

      this._id = m.prop(args._id);
      this.name = m.prop(args.name);

      this.dimensions = {
        'height': m.prop(args.dimensions.height),
        'width': m.prop(args.dimensions.width)
      };
      this.accentWall = {
        'color': m.prop(args.accentWall.color),
        'location': m.prop(args.accentWall.location)
      };

      this.devices = args.devices.map(function(device) {
        return new DeviceModel(device);
      });
    };

    ClassroomModel.get = ClassroomModel.prototype.get = function(args) {
      return m.request({
        'method': 'GET',
        'url': urlBase + '/classroom/' + (args && args._id ? args._id() : ''),
        'type': ClassroomModel
      });
    }

    ClassroomModel.save = ClassroomModel.prototype.save = function(data) {
      data = data || this;
      return m.request({
        'method': (data._id() ? 'PUT' : 'POST'),
        'url': urlBase + '/classroom/' + (data._id() ? data._id() : ''),
        'data': data,
        'type': ClassroomModel
      });
    }

    var DeviceModel = function(args) {
      args = args || {},
        args.screen = args.screen || {},
        args.location = args.location || {};

      this.name = m.prop(args.name);
      this.color = m.prop(args.color);
      this.screen = {
        'width': m.prop(args.screen.width),
        'height': m.prop(args.screen.height),
        'dpi': m.prop(args.screen.dpi)
      };
      this.location = {
        'x': m.prop(args.location.x),
        'y': m.prop(args.location.y)
      };
    };

    var App = {
      'controller': function() {
        var pages = m.prop([]);

        var addPage = function(page) {
          m.startComputation();

          if (page instanceof Array)
            for (var i = 0; i < page.length; i++)
              pages().push(page[i]);
          else if (page !== null && typeof page !== 'undefined')
            pages().push(page);

          m.route(document.getElementById('page'), '/', pages().reduce(function(acc, cur) {
              return acc[cur.href] = cur.controller, acc;
            }, {}));
          m.endComputation();
        };

        var removePage = function(href) {
          m.startComputation();
          pages().splice(pages().map(function(page) { return page.href; }).indexOf(href), 1);
          addPage(null);
          m.endComputation();
        };

        var activeClassroom = m.prop();

        var setActiveClassroom = function(classroomId) {
          ClassroomModel.get({'_id': classroomId}).then(function(classroom) {
            app.activeClassroom(classroom);
            regrid();
          });
          app.removePage('/');
          app.addPage([
            {'title': 'Home', 'href': '/', 'controller': Home},
            {'title': 'Devices', 'href': '/devices'},
            {'title': 'Users', 'href': '/users'},
            {'title': 'Apps', 'href': '/apps'}
          ]);
          m.route('/');
        }

        return {
          'pages': pages,
          'activeClassroom': activeClassroom,
          'setActiveClassroom': setActiveClassroom,
          'addPage': addPage,
          'removePage': removePage
        }
      },
      'view': function(ctrl) {
        return (
          m('div', [
            m('ul', {
              'class': 'nav nav-tabs nav-justified'
            }, ctrl.pages().map(function(page) {
              return (
                m('li', {
                  'class': (m.route() === page.href ? 'active' : '')
                }, [
                  m('a', {'href': page.href, 'config': m.route}, page.title)
                ])
              );
            })),
            m('br')
          ])
        );
      }
    }

    var ClassroomSelect = (function() {
      var NewClassroomForm = {
        'controller': function(args) {
          return {
            'classrooms': args.classrooms,
            'newClassroom': m.prop(null)
          }
        },
        'view': function(ctrl) {
          if (ctrl.newClassroom() === null)
            return (
              m('a.list-group-item', {
                'onclick': function() {
                  ctrl.newClassroom(new ClassroomModel());
                }
              }, [
                'Create new classroom'
              ])
            );
          else
            return (
              m('form', [
                m('h4', 'New classroom'),
                m('div.form-group', [
                  m('input.form-control', {
                    'placeholder': 'Classroom name',
                    'oninput': m.withAttr('value', ctrl.newClassroom().name),
                    'value': ctrl.newClassroom().name() || ''
                  })
                ]),
                m('div.form-group.form-inline', [
                  m('input.form-control', {
                    'placeholder': 'X (~ft)',
                    'oninput': m.withAttr('value', ctrl.newClassroom().dimensions.height),
                    'value': ctrl.newClassroom().dimensions.height() || ''
                  }),
                  ' x ',
                  m('input.form-control', {
                    'placeholder': 'Y (~ft)',
                    'oninput': m.withAttr('value', ctrl.newClassroom().dimensions.width),
                    'value': ctrl.newClassroom().dimensions.width() || ''
                  })
                ]),
                m('div.form-group.form-inline', [
                  m('input.form-control', {
                    'placeholder': 'Accent wall color',
                    'style': 'background-color: ' + ctrl.newClassroom().accentWall.color(),
                    'oninput': m.withAttr('value', ctrl.newClassroom().accentWall.color),
                    'value': ctrl.newClassroom().accentWall.color() || ''
                  }),
                  ' ',
                  m('select.form-control', {
                    'oninput': m.withAttr('value', ctrl.newClassroom().accentWall.location),
                    'value': ctrl.newClassroom().accentWall.location() || 1
                  }, [
                    m('option', {'value': 1}, 'Top'),
                    m('option', {'value': 2}, 'Right'),
                    m('option', {'value': 3}, 'Bottom'),
                    m('option', {'value': 4}, 'Left')
                  ])
                ]),
                m('button.btn.btn-success.pull-right', {
                  'onclick': function() {
                    ctrl.newClassroom().save().then(function(classroom) {
                      ctrl.classrooms().push(classroom);
                    });
                    ctrl.newClassroom(null);
                  }
                }, [
                  'Create'
                ])
              ])
            );
        }
      }

      var main = {
        'controller': function() {
          return {
            'classrooms': m.request({'method': 'GET', 'url': urlBase + '/classroom', 'type': ClassroomModel}),
          }
        },
        'view': function(ctrl) {
          return m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('div.list-group', [
                ctrl.classrooms().map(function(classroom) {
                  return m('a.list-group-item', {'onclick': function() { app.setActiveClassroom(classroom._id); }}, classroom.name());
                }),
                m('br'),
                m.component(NewClassroomForm, {'classrooms': ctrl.classrooms})
              ])
            ])
          ]);
        }
      };

      return main;
    }());

    var Home = {
      controller: function() {

      },
      view: function(ctrl) {
        var w = app.activeClassroom().dimensions.width(),
          h = app.activeClassroom().dimensions.height();

        var wallDir = ['top', 'right', 'bottom', 'left'];
        var accentWall = 'border-' + wallDir[app.activeClassroom().accentWall.location() - 1] + ': 5px solid ' + app.activeClassroom().accentWall.color() + ';';

        return m('div.container-fluid', [
          m('div.row', [
            m('div.panel.panel-default#device-well', {
              'style':
                'position: relative;' +
                'background-color: #f5f5f5;' +
                accentWall +
                'margin-left: auto; margin-right: auto;' +
                'width: ' + 60 + 'vw;' +
                'height: ' + (h / w) * 60 + 'vw;'
              }, [
                app.activeClassroom().devices.map(function(device) {
                  return m.component(DeviceView, {'device': device, 'classroomDimensions': app.activeClassroom().dimensions});
                }),
                m.component(AddDevice)
              ]
            ),
          ])
      ]);
      }
    };

    var DeviceView = {
      controller: function (args) {
        return {
          'device': m.prop(args.device),
          'classroomDimensions': args.classroomDimensions
        }
      },
      view: function(ctrl) {
        var device = ctrl.device();
        var x = device.location.x() / 100 * (60 / 100 * document.documentElement.clientWidth),
          y = device.location.y() / 100 * ((ctrl.classroomDimensions.height() / ctrl.classroomDimensions.width() * 60) / 100 * document.documentElement.clientWidth);
        return m('div.interact', {
          'style': 'position: absolute; webkit-transform: translate(' + x + 'px, ' + y + 'px); transform: translate(' + x + 'px, ' + y + 'px);',
          'data-x': x,
          'data-y': y,
          'onmouseup': function(e) {
              ctrl.device().location.x(parseInt(100 * 100 * e.target.parentNode.dataset.x / (60 * document.documentElement.clientWidth)));
              ctrl.device().location.y(parseInt(100 * 100 * e.target.parentNode.dataset.y / ((ctrl.classroomDimensions.height() / ctrl.classroomDimensions.width() * 60) * document.documentElement.clientWidth)));
              app.activeClassroom().save();
            }
          }, [
          m('div.panel.panel-default', {'style':
            'margin-left: auto; margin-right: auto;' +
            'background-color: ' + device.color() + ';' +
            'width: ' + device.screen.width() / device.screen.dpi() / 12 * 60 / app.activeClassroom().dimensions.width() + 'vw;' +
            'height: ' + device.screen.height() / device.screen.dpi() / 12 * 60 / app.activeClassroom().dimensions.width() + 'vw;'
          }),
          m('div', {'style': 'text-align: center; margin-top: -1em'}, device.name())
        ])
      }
    }

    var AddDevice = {
      controller: function(args) {
        var deviceToAdd = m.prop(null);
        var addDevice = function() {
          app.activeClassroom().devices.push(deviceToAdd());
          app.activeClassroom().save();
          deviceToAdd(null);
        }
        return {
          'deviceToAdd': deviceToAdd,
          'addDevice': addDevice
        }
      },
      view: function(ctrl) {
        var toggle;
        if (ctrl.deviceToAdd() === null)
          toggle = (
            m('button.btn.btn-lg.btn-success', {
              'style': 'border-radius: 50%',
              'onclick': function(e) {
                ctrl.deviceToAdd(new DeviceModel({'location': {'x': 0, 'y': 0}, 'screen': {'width': 1000, 'height': 1000, 'dpi': 100}}));
              }
            }, [
              "+"
            ])
          );
        else
          toggle = (
            m('div.panel.panel-default', {'style': 'padding: 1em'},
              m('form', [
                m('input.form-group.form-control', {
                  'placeholder': 'Device name',
                  'oninput': m.withAttr('value', ctrl.deviceToAdd().name),
                  'value': ctrl.deviceToAdd().name() || ''
                }),
                m('input.form-group.form-control', {
                  'placeholder': 'Device color',
                  'style': 'background-color: ' + ctrl.deviceToAdd().color(),
                  'oninput': m.withAttr('value', ctrl.deviceToAdd().color),
                  'value': ctrl.deviceToAdd().color() || ''
                }),
                m('button.btn.btn-success', {
                  'onclick': function(e) {
                    ctrl.addDevice();
                  }
                }, [
                  'Create'
                ])
              ])
            )
          );
        return m('div', {'style': 'position: absolute; bottom: 0.5em; right: 0.5em'}, toggle);
      }
    }

    window.onload = function() {
      m.route.mode = 'hash';
      var app = window.app = m.mount(document.getElementById('navigation'), App);
      app.addPage({'title': 'Select a classroom', 'href': '/', 'controller': ClassroomSelect});
    };
  </script>
</head>
<body>
<div id="navigation"></div>
<div id="page"></div>
</body>
</html>
