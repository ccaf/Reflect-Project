<!DOCTYPE html>
<html>
<head>
  <script src="../lib/mithril.min.js"></script>
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    var urlBase = (typeof require === 'undefined' ? window.location.origin + '/api' : 'http://localhost:1867/api');

    var App = {
      'controller': function() {
        var pages = m.prop([]);

        var addPage = function(page) {
          m.startComputation();

          if (page instanceof Array)
            for (var i = 0; i < page.length; i++)
              pages().push(page[i]);
          else if (page !== null && typeof page !== 'undefined')
            pages().push(page);

          m.route(document.getElementById('page'), '/', pages().reduce(function(acc, cur) {
              return acc[cur.href] = cur.controller, acc;
            }, {}));
          m.endComputation();
        };

        var removePage = function(href) {
          m.startComputation();
          pages().splice(pages().map(function(page) { return page.href; }).indexOf(href), 1);
          addPage(null);
          m.endComputation();
        };

        var activeClassroom = m.prop();

        return {
          'pages': pages,
          'activeClassroom': activeClassroom,
          'addPage': addPage,
          'removePage': removePage
        }
      },
      'view': function(ctrl) {
        return m('ul', {'class': 'nav nav-tabs nav-justified'}, ctrl.pages().map(function(page) {
          return m('li', {'class': (m.route() === page.href ? 'active' : '')}, m('a', {'href': page.href, 'config': m.route}, page.title));
        }));
      }
    }

    var ClassroomSelect = {
      'controller': function() {
        var classrooms = m.request({'method': 'GET', 'url': urlBase + '/classroom'});
        return {
          'classrooms': classrooms
        }
      },
      'view': function(ctrl) {
        return m('div', [
          m('form.form-inline', [
            m('input.form-control', {'placeholder': 'New classroom'}),
            m('button.btn.btn-success', 'Create')
          ]),
          m('div.list-group', ctrl.classrooms().map(function(classroom) {
          return m('a.list-group-item', {'onclick': function(e) {
            app.activeClassroom = m.request({'method': 'GET', 'url': urlBase + '/classroom/' + classroom._id});
            app.removePage('/');
            app.addPage([
              {'title': 'Home', 'href': '/', 'controller': Home},
              {'title': 'Devices', 'href': '/devices'},
              {'title': 'Users', 'href': '/users'},
              {'title': 'Apps', 'href': '/apps'}
            ]);
            m.route('/');
          }}, classroom.name);
        }))]);
      }
    };

    var Home = {
      controller: function() {

      },
      view: function() {
        return m('div', 'hello');
      }
    };

    window.onload = function() {
      m.route.mode = 'hash';
      var app = window.app = m.mount(document.getElementById('navigation'), App);
      app.addPage({'title': 'Select a classroom', 'href': '/', 'controller': ClassroomSelect});
    };
  </script>
</head>
<body>
<div id="navigation"></div>
<div id="page"></div>
</body>
</html>
