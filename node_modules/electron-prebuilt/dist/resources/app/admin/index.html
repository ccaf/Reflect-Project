<!DOCTYPE html>
<html>
<head>
  <script src="../lib/mithril.min.js"></script>
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    /*
    TODO

    - create classroom, device models with casting from request
    - create stylesheet and remove as many (all?) styles as possible from source
    - create helpers: ifElse(condition, return_if_true, return_if_false),
      two way binding, object chaining?

    */

    var urlBase = (typeof require === 'undefined' ? window.location.origin + '/api' : 'http://localhost:1867/api');

    var App = {
      'controller': function() {
        var pages = m.prop([]);

        var addPage = function(page) {
          m.startComputation();

          if (page instanceof Array)
            for (var i = 0; i < page.length; i++)
              pages().push(page[i]);
          else if (page !== null && typeof page !== 'undefined')
            pages().push(page);

          m.route(document.getElementById('page'), '/', pages().reduce(function(acc, cur) {
              return acc[cur.href] = cur.controller, acc;
            }, {}));
          m.endComputation();
        };

        var removePage = function(href) {
          m.startComputation();
          pages().splice(pages().map(function(page) { return page.href; }).indexOf(href), 1);
          addPage(null);
          m.endComputation();
        };

        var activeClassroom = m.prop();

        var setActiveClassroom = function(classroomId) {
          app.activeClassroom = m.request({'method': 'GET', 'url': urlBase + '/classroom/' + classroomId});
          app.removePage('/');
          app.addPage([
            {'title': 'Home', 'href': '/', 'controller': Home},
            {'title': 'Devices', 'href': '/devices'},
            {'title': 'Users', 'href': '/users'},
            {'title': 'Apps', 'href': '/apps'}
          ]);
          m.route('/');
        }

        return {
          'pages': pages,
          'activeClassroom': activeClassroom,
          'setActiveClassroom': setActiveClassroom,
          'addPage': addPage,
          'removePage': removePage
        }
      },
      'view': function(ctrl) {
        return m('ul', {'class': 'nav nav-tabs nav-justified'}, ctrl.pages().map(function(page) {
          return m('li', {'class': (m.route() === page.href ? 'active' : '')}, m('a', {'href': page.href, 'config': m.route}, page.title));
        }));
      }
    }

    var ClassroomSelect = {
      'controller': function() {
        var classrooms = m.request({'method': 'GET', 'url': urlBase + '/classroom'});
        var createNew = m.prop(false);
        var newClassroom = m.prop("");
        return {
          'classrooms': classrooms,
          'createNew': createNew,
          'newClassroom': newClassroom
        }
      },
      'view': function(ctrl) {
        return m('div.row', [
          m('div.col-md-4.col-md-offset-4', [
            m('div.list-group', [
              ctrl.classrooms().map(function(classroom) {
                return m('a.list-group-item', {'onclick': function() { app.setActiveClassroom(classroom._id); }}, classroom.name);
              }),
              m('br'),
              (ctrl.createNew() ?
                m('form.input-group', [
                  m('input.form-control', {'placeholder': 'New classroom', 'oninput': m.withAttr('value', ctrl.newClassroom), 'value': ctrl.newClassroom()}),
                  m('span.input-group-btn', [
                    m('input[type=\'submit\'].btn.btn-success', {'disabled': ctrl.newClassroom().length < 1, 'onclick' : function(e) {
                      var newClassroom = ctrl.newClassroom();
                      ctrl.newClassroom('');
                      ctrl.createNew(false);
                      m.request({'method': 'POST', 'url': urlBase + '/classroom', 'data': {'name': newClassroom}}).then(function(classroom) {
                        ctrl.classrooms(classroom[0]);
                      });
                    }}, 'Create')
                  ])
                ]) :
                m('a.list-group-item', {'onclick': function() { ctrl.createNew(true); }}, 'Create new classroom')
              )
            ])
          ])
        ]);
      }
    };

    var Home = {
      controller: function() {

      },
      view: function(ctrl) {
        var w = app.activeClassroom().dimensions.width, h = app.activeClassroom().dimensions.height;
        return m('div.container-fluid', [
          m('div.row', [
            m('br'),
            m('div.panel.panel-default', {'style':
              'position: relative;' +
              'background-color: #f5f5f5;' +
              'margin-left: auto; margin-right: auto;' +
              'width: ' + 60 + 'vw;' +
              'height: ' + (h / w) * 60 + 'vw;'},
              [
                app.activeClassroom().devices.map(function(device) {
                  return m.component(Device, {'device': device});
                }),
                m.component(AddDevice)
              ]
            ),
          ])
      ]);
      }
    };

    var Device = {
      controller: function (args) {
        var device = m.prop(args.device);
        return {
          'device': device
        }
      },
      view: function(ctrl) {
        var device = ctrl.device();
        return m('div', {'style':
          'position: absolute;' +
          'left: ' + device.location.x / 100 * 60 + 'vw;' +
          'top: ' + device.location.y / 100 * 60 + 'vw;'
          }, [
          m('div.panel.panel-default', {'style':
            'margin-left: auto; margin-right: auto;' +
            'background-color: ' + device.color + ';' +
            'width: ' + device.screen.width / device.screen.dpi / 12 * 60 / app.activeClassroom().dimensions.width + 'vw;' +
            'height: ' + device.screen.height / device.screen.dpi / 12 * 60 / app.activeClassroom().dimensions.width + 'vw;'
          }),
          m('div', {'style': 'text-align: center; margin-top: -1em'}, device.name)
        ])
      }
    }

    var AddDevice = {
      controller: function(args) {
        var deviceToAdd = m.prop(null);
        var addDevice = function() {
          deviceToAdd()['name'] = deviceToAdd().name();
          deviceToAdd()['color'] = deviceToAdd().color();
          app.activeClassroom().devices.push(deviceToAdd());
          deviceToAdd(null);
        }
        return {
          'deviceToAdd': deviceToAdd,
          'addDevice': addDevice
        }
      },
      view: function(ctrl) {
        var toggle;
        if (ctrl.deviceToAdd() === null)
          toggle = m('button.btn.btn-lg.btn-success', {'style': 'border-radius: 50%', 'onclick': function(e) {
            ctrl.deviceToAdd({'name': m.prop(''), 'color': m.prop(''), 'location': {'x': 0, 'y': 0}, 'screen': {'width': 1000, 'height': 1000, 'dpi': 100}});
          }}, "+");
        else
          toggle = m('div.panel.panel-default', {'style': 'padding: 1em'},
            m('form', [
              m('input.form-group.form-control', {'placeholder': 'Device name', 'oninput': m.withAttr('value', ctrl.deviceToAdd().name), 'value': ctrl.deviceToAdd().name()}),
              m('input.form-group.form-control', {'placeholder': 'Device color', 'oninput': m.withAttr('value', ctrl.deviceToAdd().color), 'value': ctrl.deviceToAdd().color()}),
              m('input[type=submit].btn.btn-success', {'onclick': function(e) {
                ctrl.addDevice();
              }}, 'Create')
            ])
          );
        return m('div', {'style': 'position: absolute; bottom: 0.5em; right: 0.5em'}, toggle);
      }
    }

    window.onload = function() {
      m.route.mode = 'hash';
      var app = window.app = m.mount(document.getElementById('navigation'), App);
      app.addPage({'title': 'Select a classroom', 'href': '/', 'controller': ClassroomSelect});
    };
  </script>
</head>
<body>
<div id="navigation"></div>
<div id="page"></div>
</body>
</html>
