var state = (function() {
  function state(data) {
    var diff = {};
    var patch = {};

    var get = function(path) {
      path = path.split('.');

      var cur, lastDiff, curData = data, curDiff = diff;

      while (path.length > 0) {
        cur = path.shift();
        curData = curData[cur];
        lastDiff = curDiff;
        curDiff = curDiff[cur] || (curDiff[cur] = {});
      }

      lastDiff[cur] = curData;

      return curData;
    };

    var set = function(path, value) {
      get(path);

      path = path.split('.');
      var cur, lastPatch, curPatch = patch;
      while (path.length > 0) {
        cur = path.shift();
        lastPatch = curPatch;
        curPatch = curPatch[cur] || (curPatch[cur] = {});
      }

      lastPatch[cur] = value;

      return value;
    };

    this.use = function(callback) {
      callback({'get': get, 'set': set});
      console.log(diff);
      console.log(patch);
    };
  }

  return state;
}());
