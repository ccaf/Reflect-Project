<!DOCTYPE html>
<html>
<head>
  <script src="/lib/mithril.js"></script>
  <script src="/lib/tuio.js"></script>
  <script src="/lib/q.min.js"></script>
  <script src="/lib/interact-1.2.4.js"></script>
  <script src="/node_modules/checkerboard/lib/checkerboard.js"></script>
  <script src="/lib/require.js"></script>
  <link rel="stylesheet" href="/client/styles.css" />
  <link rel="stylesheet" href="/lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    var stm, conn, associated = false;
    var classrooms = [];

    function css(url) {
      var link = document.createElement("link");
      link.type = "text/css";
      link.rel = "stylesheet";
      link.href = url;
      link.classList.add('app-css');
      document.getElementsByTagName("head")[0].appendChild(link);
    }

    function parameter(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
      return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function reset() {
      [].slice.call(document.getElementsByClassName('app-css')).forEach(function(link) {
        link.parentNode.removeChild(link);
      });
      var el = document.getElementById('app');
      if (el !== null)
        el.parentNode.removeChild(el);
      el = document.createElement('div');
      el.id = 'app';
      return el;
    }

    window.onload = function() {
      var menuLoaded;
      (function() {
        var menuButton = document.querySelector('.menu-button');
        var timeout, toggled = false;

        menuButton.ontouchstart = menuButton.onmousedown = function(e) {
          toggled = true;
          menuButton.classList.add('activated');
          timeout = setTimeout(function() {
            if (toggled) {
              document.querySelector('.circle').classList.add('open');
              document.querySelector('.corner-shadow').style.width = '600px';
              document.querySelector('.corner-shadow').style.height = '700px';
              document.querySelector('.corner-shadow').style.opacity = '0.4';
            }
          }, 2000);
        }

        interact('.menu-button')
          .draggable({
            'onmove': function(e) {
              var x, y;
              x = (parseFloat(e.target.getAttribute('data-x')) || 0) + e.dx;
              y = (parseFloat(e.target.getAttribute('data-y')) || 0) + e.dy;

              e.target.setAttribute('data-x', x);
              e.target.setAttribute('data-y', y);

              if (!document.querySelector('.circle').classList.contains('open') || !toggled)
                return (toggled = x < 20 && y < 29);

              e.target.style.webkitTransform =
              e.target.style.transform =
                'translate(' + x + 'px, ' + y + 'px)';
            },
            'onend': function(e) {
              e.target.setAttribute('data-x', 0);
              e.target.setAttribute('data-y', 0);

              e.target.style.webkitTransition = e.target.style.transition = '0.25s all';
              e.target.style.webkitTransform =
              e.target.style.transform = '';
              setTimeout(function() {
                e.target.style.webkitTransition = e.target.style.transition = '';
              }, 250);
            }
          })

        interact('.circle span')
          .dropzone({
            'accept': '.menu-button',
            'ondragenter': function(e) {
              if (!document.querySelector('.circle').classList.contains('open'))
                return;

              e.relatedTarget.style.opacity = 0;
              e.target.classList.add('activated');
            },
            'ondragleave': function(e) {
              if (!document.querySelector('.circle').classList.contains('open'))
                return;

              e.relatedTarget.style.opacity = 1;
              e.target.classList.remove('activated');
            },
            'ondrop': function(e) {
              if (!document.querySelector('.circle').classList.contains('open'))
                return;

              e.relatedTarget.style.opacity = 1;
              e.target.classList.remove('activated');

              switch (e.target.getAttribute('data-action')) {
                case 'close': document.title = 0; break;
                case 'return': if (menuLoaded) stm.try(function(state) { state.device('app', undefined); }); break;
              }
            },
            'ondropdeactivate': function(e) {
              e.relatedTarget.style.opacity = 1;
              e.target.classList.remove('activated');
            }
          })

        menuButton.ontouchend = menuButton.onmouseup = function(e) {
          toggled = false;
          menuButton.classList.remove('activated');
          clearTimeout(timeout);
          setTimeout(function() {
            document.querySelector('.circle').classList.remove('open');
            document.querySelector('.corner-shadow').style.width = '450px';
            document.querySelector('.corner-shadow').style.height = '550px';
            document.querySelector('.corner-shadow').style.opacity = '0.25';
          }, 50);
        }

        var items = document.querySelectorAll('.circle span');

        for(var i = 0, l = items.length; i < l; i++) {
          items[i].style.left = (50 - 75*Math.cos(-(Math.PI / 2) * Math.PI - 2*(1/(3*l))*i*Math.PI)).toFixed(4) + "%";
          items[i].style.top = (50 + 75*Math.sin(-(Math.PI / 2) * Math.PI - 2*(1/(3*l))*i*Math.PI)).toFixed(4) + "%";
        }
      }());

      new TUIO.Client();

      (function() {
        var pageDirectionX;

        document.addEventListener('touchstart', function(e){
            pageDirectionX = e.changedTouches[0].pageX;
        });

        document.addEventListener('touchmove', function(e){
          if (e.target.tagName === 'INPUT')
            return;

          if (pageDirectionX !== e.changedTouches[0].pageX)
              e.preventDefault();
        });
      }());

      document.onmousedown = function (event) {
        if(event.button == 2)
           return false;
      }

      conn = new WebSocket('ws://' + window.location.hostname + ':' + (parameter('port') || '1808'));

      conn.onopen = function() {
        stm = new Checkerboard(conn);

        m.route.mode = 'hash';
        m.route(document.getElementById('app'), '/', {
          '/': ClassroomSelect,
          ':classroom': DeviceSelect,
          ':classroom/:device': Home
        });

        m.startComputation();
        stm.on('ready', function(state) {
          classrooms = state('classrooms');
          m.endComputation();

          stm.sync(250);
        });

        var savedApp, app, api, shared;
        requirejs(['/lib/rpapi.js'], function(_api) {
          api = _api;
        });
        var project;
        function update(state) {
          m.startComputation();

          var device = state.device;

          if (typeof device === 'undefined') {
            m.endComputation();
            return;
          }

          if (device('frozen'))
            document.getElementsByTagName('body')[0].classList.add('frozen');
          else
            document.getElementsByTagName('body')[0].classList.remove('frozen');

          if (typeof device('project') !== 'undefined' && device('project') !== project) {
            project = device('project');
            var el = reset();
            var frame = document.createElement('iframe');
            frame.src = location.origin + '/#' + m.route.param('classroom') + '/' + device('project');
            el.appendChild(frame);
            document.body.appendChild(el);
          }
          else if (device('app') !== savedApp && typeof device('app') !== 'undefined') {
            if (typeof app !== 'undefined' && typeof app.unloadApp === 'function')
              app.unloadApp();

            savedApp = device('app');
            var el = reset();

            var deps = ['/apps/' + device('app') + '/' + state.apps[device('app')]('client')];
            if (typeof state.apps[device('app')]('shared') !== 'undefined')
              deps.push('/apps/' + device('app') + '/' + state.apps[device('app')]('shared'));
            requirejs(deps, function(_app, _shared) {
              shared = _shared;
              app = _app;
              document.body.appendChild(el);
              document.body.style.backgroundColor = '';
              app.startApp(stm, el, api.createBound(device('app')), _shared);
            });
          }
          else if (typeof device('project') === 'undefined' && typeof device('app') === 'undefined') {
            document.body.style.backgroundColor = state.device('color');
            project = undefined;
            app = undefined;
            savedApp = undefined;
            var el = reset();
            requirejs(['/apps/launcher/client.js'], function(launcher) {
              app = launcher;
              document.body.appendChild(el);
              launcher.startApp(stm, el, api.createBound('launcher'));
            });
          }

          m.endComputation();
        }

        stm.on('change', function(state) {
          if (state.device('app') !== savedApp)
            menuLoaded = false;
          update(state);
        });
        stm.on('attempt', function(state) {
          if (state.device('app') !== savedApp)
            menuLoaded = true;
          update(state);
        });
      };
    }

    var ClassroomSelect = {
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a classroom']),
              m('div.list-group', [
                classrooms.map(function(classroom) {
                  return m('a.list-group-item', {'href': classroom.id, 'config': m.route}, classroom.props.name)
                })
              ])
            ])
          ])
        );
      }
    };

    var DeviceSelect = {
      'view': function(ctrl) {
        var classroom = classrooms[classrooms.map(function(c) { return c.id; }).indexOf(parseInt(m.route.param('classroom')))] || {};
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a device']),
              m('div.list-group', [
                (classroom.devices || []).map(function(device) {
                  return m('a.list-group-item', {'href': m.route.param('classroom') + '/' + device.id, 'config': m.route}, device.name)
                })
              ])
            ])
          ])
        );
      }
    };

    var Home = {
      controller: function() {
        var interval = setInterval(function() {
          if (conn.readyState === conn.OPEN) {
            clearInterval(interval);
            stm.send('data-associate', {'classroom': m.route.param('classroom'), 'device': m.route.param('device')});
            associated = true;
          }
        }, 100);
      }
    };
  </script>
</head>
<body oncontextmenu="return false">
  <div class="corner-shadow">&nbsp;</div>
  <nav class="circular-menu">

    <div class="circle">
      <span data-action="close" class="glyphicon glyphicon-remove" style="color: red"></span>
      <span data-action="return" class="glyphicon glyphicon-arrow-left"></span>
      <span data-action="project" class="glyphicon glyphicon-share-alt"></span>
    </div>

    <span class="menu-button">
      <span class="glyphicon glyphicon-lock"></span>
    </div>

  </nav>
<div id="app"></div>
</body>
</html>
