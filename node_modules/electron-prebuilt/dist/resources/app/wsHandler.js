(function() {
  var ws = require('ws').Server;

  var createServer = function(messageHandler, port) {
    wss = new ws({'port': port});

    var handle = {};
    handle.conns = [];
    handle.sendAll = function (channel, message) {
      for (var i = 0; i < handle.conns.length; i++)
        if (handle.conns[i]) handle.conns[i].send(JSON.stringify({'channel': channel, 'message': message}));
    };

    wss.on('connection', function (wsConn) {
      wsConn.id = handle.conns.length;
      handle.conns.push(wsConn);

      wsConn.sendObj = function (channel, message) {
        wsConn.send(JSON.stringify({'channel': channel, 'message': message}));
      };

      if ('event-open' in messageHandler)
        messageHandler['event-open'](wsConn, null, null);

      wsConn.on('message', function (json, flags) {
        var envelope = JSON.parse(json);
        if (envelope.channel in messageHandler)
          messageHandler[envelope.channel](wsConn, envelope.message, flags);
      });

      wsConn.on('close', function (code, json) {
        if ('event-close' in messageHandler)
          messageHandler['event-close'](wsConn, null, null);

        handle.conns[wsConn.id] = undefined;
      });
    });

    return handle;
  };

  module.exports.createServer = createServer;

}());
