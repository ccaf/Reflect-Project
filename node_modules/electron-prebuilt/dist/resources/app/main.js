var app = require('app');

var BrowserWindow = require('browser-window'),
  mainWindow = null;

var Datastore = require('nedb'),
  db = global.db = new Datastore({filename: __dirname + '/embedded.db', autoload: true});

var ports = {
  'http': 1867,
  'wsAdmin': 904,
  'wsClient': 905
};

require('./httpServer').init(ports.http);

var wsClient = null, wsAdmin = null;

var wsClientMessageHandler = {
  'event-set-active': function(wsConn, message, flags) {
    wsConn.index = message.index;
    db.find({'_id': message.classroom}, function(err, docs) {
      var classroom = docs[0];
      classroom.devices[message.index].connected = true;
      db.update({'_id': message.classroom}, classroom);
      wsAdmin.sendAll('event-client-updated', {'classroom': message.classroom, 'index': message.index, 'device': classroom.devices[message.index]});
    });
  }
};

var wsAdminMessageHandler = {
  'action-get-client': function(wsConn, message, flags) {
    //return clients[message.id];
  },
  'action-get-clients': function(wsConn, message, flags) {
    //wsConn.sendObj('data-get-clients', clients.map(function(client) { client.state = undefined; return client; }));
  }
};

ws = require('./wsHandler');
wsClient = ws.createServer(wsClientMessageHandler, ports.wsClient);
wsAdmin = ws.createServer(wsAdminMessageHandler, ports.wsAdmin);

app.on('ready', function() {
  mainWindow = new BrowserWindow({width: 800, height: 600});
  mainWindow.loadUrl('file://' + __dirname + '/admin/index.html');

  mainWindow.on('closed', function() {
    mainWindow = null;
  });
});

app.on('window-all-closed', function() {
  if (process.platform != 'darwin')
    app.quit();
});
