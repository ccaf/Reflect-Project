define(function() {
  var exports = {};
  var cb;

  var puzzle, puzzleData;
  var loaded;
  exports.startApp = function(_cb, parentElement) {
    cb = _cb;
    css('/apps/qanda/styles.css');

    cb.on('change', function(state) {
      if (!loaded)
        return;

      if (state.global.deviceState[state.device('id')]('puzzle') !== puzzle) {
        puzzle = state.global.deviceState[state.device('id')]('puzzle');
        puzzleData = state.global.puzzles(puzzle);
      }
    });

    require(['/apps/qanda/puzzles.js'], function(puzzles) {
      cb.try(function(state) {
        if (typeof state.global('deviceState') === 'undefined')
          state.global('deviceState', {});
        if (typeof state.global.deviceState(state.device('id')) === 'undefined')
          state.global.deviceState(state.device('id'), {});
        if (typeof state.global.deviceState[state.device('id')]('puzzle') === 'undefined')
          state.global.deviceState[state.device('id')]('puzzle', 'default');
        if (typeof state.global('puzzles') === 'undefined')
          state.global('puzzles', puzzles);
      }).then(function(state) {
        loaded = true;

        puzzle = state.global.deviceState[state.device('id')]('puzzle');
        puzzleData = state.global.puzzles(puzzle);

        cb.try(function(_state) {
          _state.global.deviceState[_state.device('id')]('puzzle')
        });

        m.render(parentElement, m.component(Root, {'puzzleData': puzzleData}));
      }).done();
    });
  };

  var Root = {
    'view': function(ctrl, args) {
      return (
        m('span', [
          m('div#clues', [
            args.puzzleData.map(function(puzzleDatum) {
              return m('div', [
                m('span.clue', [puzzleDatum[0]]),
                m('span.clueHolder', [puzzleDatum[1]])
              ]);
            })
          ]),
          m('div', [
            args.puzzleData.map(function(puzzleDatum) {
              return m('span.answer', [
                puzzleDatum[1]
              ]);
            })
          ])
        ])
      );
    }
  };

  require(['apps/qanda/interact.js'], function(interact) {
    interact('.answer')

  });

  return exports;
});
