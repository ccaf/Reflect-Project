<!DOCTYPE html>
<html>
<head>
  <script src="/lib/mithril.js"></script>
  <script src="/shared/models.js"></script>
  <script src="/lib/q.min.js"></script>
  <script src="/lib/checkerboard.js"></script>

  <link rel="stylesheet" href="/lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    var stm, conn;
    window.onload = function(e) {
      conn = new WebSocket('ws://' + window.location.hostname + ':904/');

      var appScript = document.createElement('script');
      appScript.type = 'text/javascript';
      appScript.onreadystatechange = appScript.onload = function(e) {};

      conn.onopen = function() {
        stm = new SharedTransactionalMemory(conn);

        stm.onready = stm.onchange = function(state) {
          if (state.appId() !== app.activeApp()) {
              app.activeApp(state.appId());
              appScript.src = '/apps/' + state.appId() + '/main.js';
              document.getElementsByTagName('head')[0].appendChild(appScript);
          }
        };
      };

      var actionHandler = window.actionHandler = {
        'ping': function() {
          conn.sendObj('pong');
        }
      };

      conn.onmessage = function(json) {
        var envelope = JSON.parse(json.data);
        if (envelope.channel in actionHandler)
          actionHandler[envelope.channel](envelope.message);
      };

      var app = window.app = m.mount(document.getElementById('app'), App);
    }

    var App = {
      'controller': function(args) {
        args = args || {};

        var activeClassroom = m.prop(null);
        var activeDevice = m.prop(null);
        var activeApp = m.prop(null);
        var state = m.prop(args.state || 'ClassroomSelect');

        var setActiveClassroom = function(classroom) {
          ClassroomModel.get(classroom).then(function(classroom) {
            activeClassroom(classroom);
            state('DeviceSelect');
          });
        };

        var setActiveDevice = function(_id) {
          conn.send(JSON.stringify({'channel': 'data-associate', 'message': {'classroom': activeClassroom()._id(), '_id': _id}}));
          activeDevice(activeClassroom().devices()[activeClassroom().devices().map(function(device) { return device._id(); }).indexOf(_id)]);
        };

        var currentApp = m.prop();
        var load = function(appToLoad) {
          m.startComputation();
          currentApp(appToLoad);
          state('App');
          m.endComputation();
        }

        return {
          'activeClassroom': activeClassroom,
          'activeDevice': activeDevice,
          'activeApp': activeApp,
          'state': state,
          'setActiveClassroom': setActiveClassroom,
          'setActiveDevice': setActiveDevice
        }
      },
      'view': function(ctrl) {
        switch(ctrl.state()) {
          case 'ClassroomSelect':
            return m.component(ClassroomSelect);
          case 'DeviceSelect':
            return m.component(DeviceSelect);
          case 'Connected':
            document.body.style.backgroundColor = ctrl.activeDevice().color();
            break;
          case 'App':
            return m('iframe', {
              'style': 'border:none; padding: none; margin: none',
              'height': '100%',
              'width': '100%',
              'src': '/apps/' + ctrl.app() + '/client'
            })
        }
      }
    }

    var ClassroomSelect = {
      'controller': function(args) {
        return {
          'classrooms': ClassroomModel.get()
        };
      },
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a classroom']),
              m('div.list-group', [
                ctrl.classrooms().map(function(classroom) {
                  return m('a.list-group-item', {'onclick': function(e) { app.setActiveClassroom(classroom); }}, [classroom.name()])
                })
              ])
            ])
          ])
        );
      }
    };

    var DeviceSelect = {
      'controller': function(args) {
        return {
          'devices': app.activeClassroom().devices
        };
      },
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a device']),
              m('div.list-group', [
                ctrl.devices().map(function(device) {
                  return m('a.list-group-item', {'onclick': function(e) { app.setActiveDevice(device._id()); }}, [device.name()])
                })
              ])
            ])
          ])
        );
      }
    };
  </script>
</head>
<body>
<div style="height: 100%" id="app"></div>
</body>
</html>
