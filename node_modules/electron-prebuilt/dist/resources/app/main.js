var app = require('app');

var BrowserWindow = require('browser-window'),
  mainWindow = null;

var Datastore = require('nedb'),
  db = global.db = new Datastore({filename: __dirname + '/embedded.db', autoload: true});

var ports = {
  'http': 1867,
  'wsAdmin': 904,
  'wsClient': 905
};

require('./httpServer').init(ports.http);

var wsClient = null, wsAdmin = null;

var wsClientMessageHandler = {
  'event-open': function(wsConn, message, flags) {
    wsAdmin.sendAll('event-client-connected', {'client': wsConn.id});
  },
  'action-log-in': function(wsConn, message, flags) {
    //clients[wsConn.id] = {'name': message.name, 'wsConn': wsConn};
    wsAdmin.sendAll('event-client-log-in', {'client': wsConn.id});
  },
  'data-state': function(wsConn, message, flags) {
    //clients[wsConn.id].state = message.state;
    wsAdmin.sendAll('event-client-state', {'client': wsConn.id});
  },
  'action-log-out': function(wsConn, message, flags) {
    //clients.splice(wsConn.id, 1);
    wsAdmin.sendAll('event-client-log-out', {'client': wsConn.id});
  },
  'event-close': function(wsConn, message, flags) {
    wsClientMessageHandler['action-log-out'](wsConn, message, flags);
  }
};

var wsAdminMessageHandler = {
  'action-get-client': function(wsConn, message, flags) {
    //return clients[message.id];
  },
  'action-get-clients': function(wsConn, message, flags) {
    //wsConn.sendObj('data-get-clients', clients.map(function(client) { client.state = undefined; return client; }));
  }
};

ws = require('./wsHandler');
wsClient = ws.createServer(wsClientMessageHandler, ports.wsClient);
wsAdmin = ws.createServer(wsAdminMessageHandler, ports.wsAdmin);

app.on('ready', function() {
  mainWindow = new BrowserWindow({width: 800, height: 600});
  mainWindow.loadUrl('file://' + __dirname + '/admin/index.html');

  mainWindow.on('closed', function() {
    mainWindow = null;
  });
});

app.on('window-all-closed', function() {
  if (process.platform != 'darwin')
    app.quit();
});
