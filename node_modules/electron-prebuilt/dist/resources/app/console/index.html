<!DOCTYPE html>
<html>
<head>
  <script src="/lib/mithril.js"></script>
  <script src="/lib/interact-1.2.4.js"></script>
  <script src="/lib/q.min.js"></script>
  <script src="/lib/checkerboard.js"></script>

  <link rel="stylesheet" href="/lib/css/bootstrap.min.css" />
  <link rel="stylesheet" href="styles.css" />

  <script src="controllers/ClassroomSelect.js"></script>
  <script src="controllers/App.js"></script>
  <script src="controllers/Home.js"></script>

  <script src="transform.js"></script>

  <script type="text/javascript">
    window.addEventListener('resize', m.redraw);
    var conn;

    window.onload = function() {
      conn = new WebSocket('ws://' + (typeof require === 'undefined' ? window.location.hostname : 'localhost') + ':904/');

      conn.onopen = function() {
        stm = new SharedTransactionalMemory(conn);
        stm.sync(100);
      };

      var actionHandler = {
        'event-server-disconnected': function() {
          setTimeout(function() {
            function checkStatus() {
              setTimeout(function() {
                var img;
                if ((img = document.getElementById('check')) == null) {
                  img = document.createElement('img');
                  img.style.display = 'none';
                  img.onerror = checkStatus;
                  img.onload = function() {
                    location.reload(true);
                  };
                }
                img.src = '../shared/up.png?' + Math.random();
                document.body.appendChild(img);
              }, 1000);
            }

            document.getElementById('container').innerHTML = '<center><h1>Server disconnected</h1></center>';
            checkStatus();
          }, 1000);
        },
        'ping': function() {
          conn.sendObj('pong');
        }
      };

      conn.onmessage = function(json) {
        var envelope = JSON.parse(json.data);
        if (envelope.channel in actionHandler) actionHandler[envelope.channel](envelope.message);
      };

      conn.onclose = function() {
        actionHandler['event-server-disconnected'];
      }

      m.route.mode = 'hash';
      m.route(document.getElementById('page'), '/', {
        '/': ClassroomSelect,
        ':classroom': App,
        ':classroom/:subpage': App
      });
    };
  </script>
</head>
<body>
<div id="container" class="container-fluid">
  <div id="page"></div>
</div>
</body>
</html>
