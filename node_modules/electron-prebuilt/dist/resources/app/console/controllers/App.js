var App = (function(){
  var App = {
    'controller': function() {
      var pages = m.prop([]);

      // page format: {'title': 'Select a classroom', 'href': '/', 'controller': ClassroomSelect}
      var addPage = function(page) {
        m.startComputation();

        if (page instanceof Array)
          for (var i = 0; i < page.length; i++)
            pages().push(page[i]);
        else if (typeof page !== 'undefined')
          pages().push(page);

        m.endComputation();
      };

      var removePage = function(href) {
        pages().splice(pages().map(function(page) { return page.href; }).indexOf(href), 1);
        addPage(null);
      };

      var interval = setInterval(function() {
        if (conn.readyState === conn.OPEN) {
          clearInterval(interval);
          stm.send('data-associate', {'classroom': m.route.param('classroom'), 'device': m.route.param('device')});
          associated = true;
          addPage({'title': 'Classroom', 'href': '', 'controller': Home});
        }
      }, 100);
      return {
        'pages': pages,
        'addPage': addPage,
        'removePage': removePage,
      };
    },
    'view': function(ctrl) {
      var index = typeof m.route.param('subpage') === 'undefined' ? '' : m.route.param('subpage');
      var page = ctrl.pages()[ctrl.pages().map(function(page) { return page.href; }).indexOf(index)];
      return (
        m('div', [
          m('ul', {
            'class': 'nav nav-tabs'
          }, [
            m('li', [
              m('a', {'href': '/', 'config': m.route}, 'Home')
            ]),
            ctrl.pages().map(function(page) {
              return (
                m('li', {
                  'class': (m.route.param('subpage') === page.href || (typeof m.route.param('subpage') === 'undefined' && page.href === '')  ? 'active' : '')
                }, [
                  m('a', {'href': m.route.param('classroom') + '/' + page.href, 'config': m.route}, page.title)
                ])
              );
            })
          ]),
          m('br'),
          (typeof page === 'undefined' || typeof classroom === 'undefined' ? m('br') : m.component(page.controller))
        ])
      );
    }
  };

  return App;
}());
