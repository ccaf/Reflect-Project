<!DOCTYPE html>
<html>
<head>
  <script src="../lib/mithril.js"></script>
  <script src="../lib/interact-1.2.4.js"></script>
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../shared/styles.css" />

  <script src="../shared/models.js"></script>
  <script src="../shared/controllers/ClassroomSelect.js"></script>
  <script src="../shared/polyfill.js"></script>
  <script type="text/javascript">

    function updateTransform(target) {
      var x = (parseFloat(target.getAttribute('data-x')) || 0);
      var y = (parseFloat(target.getAttribute('data-y')) || 0);
      var scale = parseFloat(target.getAttribute('data-scale')) || 1;
      var angle = parseFloat(target.getAttribute('data-angle')) || 0;

      target.style.webkitTransform =
      target.style.transform =
      'translate(' + x + 'px, ' + y + 'px)';
    }

    function standardMove(event) {}

    interact('.deviceTile')
    .draggable({
      'restrict': {
        'restriction': 'parent'
      },
      'onmove': function (event) {

        x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.dx;
        y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.dy;

        // update the posiion attributes
        event.target.setAttribute('data-x', x);
        event.target.setAttribute('data-y', y);

        updateTransform(event.target);
      }
    })
    .dropzone({
      'accept': '.appIcon',
      'ondrop': function(event) {
        conn.sendObj('action-load-app', {
          'classroom': app.activeClassroom()._id(),
          'index': event.target.getAttribute('data-index'),
          'app': event.relatedTarget.getAttribute('data-path')});
      }

    });

    interact('.appIcon')
    .draggable({
      'onstart': function(event) {
        event.target.setAttribute('data-save-webkit-transform', event.target.style.webkitTransform);
        event.target.setAttribute('data-save-transform', event.target.style.transform);

        event.target.className = 'appIcon';
      },
      'onmove': function (event) {
        x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.dx;
        y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.dy;


        // update the posiion attributes
        event.target.setAttribute('data-x', x);
        event.target.setAttribute('data-y', y);

        updateTransform(event.target);
      },
      'onend': function(event) {
        event.target.setAttribute('data-x', 0);
        event.target.setAttribute('data-y', 0);

        event.target.className = 'appIcon docked';

        event.target.style.webkitTransform = event.target.getAttribute('data-save-webkit-transform');
        event.target.style.transform = event.target.getAttribute('data-save-transform');
      }
    });

    function regrid() {
      m.redraw();
    }

    window.addEventListener('resize', regrid);

    var App = (function(){
      var App = {
        'controller': function() {
          var pages = m.prop([]);

          var addPage = function(page) {
            m.startComputation();

            if (page instanceof Array)
              for (var i = 0; i < page.length; i++)
                pages().push(page[i]);
            else if (page !== null && typeof page !== 'undefined')
              pages().push(page);

            m.route(document.getElementById('page'), '/', pages().reduce(function(acc, cur) {
                return acc[cur.href] = cur.controller, acc;
              }, {}));
            m.endComputation();
          };

          var removePage = function(href) {
            m.startComputation();
            pages().splice(pages().map(function(page) { return page.href; }).indexOf(href), 1);
            addPage(null);
            m.endComputation();
          };

          var activeClassroom = m.prop();

          var setActiveClassroom = function(classroomId) {
            ClassroomModel.get({'_id': classroomId}).then(function(classroom) {
              activeClassroom(classroom);
              regrid();
            });
            removePage('/');
            addPage([
              {'title': 'Home', 'href': '/', 'controller': Home},
              {'title': 'Devices', 'href': '/devices'},
              {'title': 'Users', 'href': '/users'},
              {'title': 'Apps', 'href': '/apps'}
            ]);
            m.route('/');
          }

          return {
            'pages': pages,
            'activeClassroom': activeClassroom,
            'setActiveClassroom': setActiveClassroom,
            'addPage': addPage,
            'removePage': removePage
          }
        },
        'view': function(ctrl) {
          return (
            m('div', [
              m('ul', {
                'class': 'nav nav-tabs nav-justified'
              }, ctrl.pages().map(function(page) {
                return (
                  m('li', {
                    'class': (m.route() === page.href ? 'active' : '')
                  }, [
                    m('a', {'href': page.href, 'config': m.route}, page.title)
                  ])
                );
              })),
              m('br')
            ])
          );
        }
      };

      return App;
    }());

    var Home = (function() {
      var Home = {
        controller: function() {

        },
        view: function(ctrl) {
          var w = app.activeClassroom().dimensions.width(),
            h = app.activeClassroom().dimensions.height();

          var wallDir = ['top', 'right', 'bottom', 'left'];
          var accentWall = 'border-' + wallDir[app.activeClassroom().accentWall.location() - 1] + ': 5px solid ' + app.activeClassroom().accentWall.color() + ';';

          return (
            m('div', [
              m('div.row', [
                m('div.panel.panel-default#device-well', {
                  'style':
                    'position: relative;' +
                    'background-color: #f5f5f5;' +
                    accentWall +
                    'margin-left: auto; margin-right: auto;' +
                    'width: ' + 60 + 'vw;' +
                    'height: ' + (h / w) * 60 + 'vw;'
                  }, [
                    app.activeClassroom().devices.map(function(device, index) {
                      return m.component(DeviceView, {'device': device, 'index': index, 'classroomDimensions': app.activeClassroom().dimensions});
                    }),
                    m.component(AddDevice)
                  ]
                )
              ]),
              m.component(AppDock)
            ])
          );
        }
      };

      var AppDock = {
        'controller': function(args) {
          return {
            'apps': [{'title': 'Mysteries', 'path': 'mysteries', 'icon': '../apps/mysteries/icon.png'}]
          };
        },
        'view': function(ctrl) {
          return (
            m('div#dock-container', [
              m('div#dock', [
                m('ul', ctrl.apps.map(function(app, index) {
                  return (
                    m('li', [
                      m('span', [app.title]),
                      m('a', {'href': 'javascript:void(0)'}, [
                        m('img.docked.appIcon', {'src': app.icon, 'data-path': app.path})
                      ])
                    ])
                  );
                })),
                m('div.base')
              ])
            ])
          );
        }
      };

      var DeviceView = {
        controller: function (args) {
          return {
            'index': m.prop(args.index),
            'device': m.prop(args.device),
            'classroomDimensions': args.classroomDimensions
          }
        },
        view: function(ctrl) {
          var device = ctrl.device();
          var x = device.location.x() / 100 * (60 / 100 * document.documentElement.clientWidth),
            y = device.location.y() / 100 * ((ctrl.classroomDimensions.height() / ctrl.classroomDimensions.width() * 60) / 100 * document.documentElement.clientWidth);
          return m('div.deviceTile', {
            'data-index': ctrl.index(),
            'style': 'position: absolute; webkit-transform: translate(' + x + 'px, ' + y + 'px); transform: translate(' + x + 'px, ' + y + 'px);',
            'data-x': x,
            'data-y': y,
            'onmouseup': function(e) {
                ctrl.device().location.x(Math.round(100 * 100 * e.target.parentNode.dataset.x / (60 * document.documentElement.clientWidth)));
                ctrl.device().location.y(Math.round(100 * 100 * e.target.parentNode.dataset.y / ((ctrl.classroomDimensions.height() / ctrl.classroomDimensions.width() * 60) * document.documentElement.clientWidth)));
                app.activeClassroom().save();
              }
            }, [
            m('div.panel.panel-default', {'style':
              'margin-left: auto; margin-right: auto;' +
              'background-color: ' + (device.connected() ? device.color() : 'gray') + ';' +
              'width: ' + device.screen.width() / device.screen.dpi() / 12 * 60 / app.activeClassroom().dimensions.width() + 'vw;' +
              'height: ' + device.screen.height() / device.screen.dpi() / 12 * 60 / app.activeClassroom().dimensions.width() + 'vw;'
            }),
            m('div', {'style': 'text-align: center; margin-top: -1em'}, device.name())
          ])
        }
      }

      var AddDevice = {
        controller: function(args) {
          var deviceToAdd = m.prop(null);
          var addDevice = function() {
            app.activeClassroom().devices.push(deviceToAdd());
            app.activeClassroom().save();
            deviceToAdd(null);
          }
          return {
            'deviceToAdd': deviceToAdd,
            'addDevice': addDevice
          }
        },
        view: function(ctrl) {
          var toggle;
          if (ctrl.deviceToAdd() === null)
            toggle = (
              m('button.btn.btn-lg.btn-success', {
                'style': 'border-radius: 50%',
                'onclick': function(e) {
                  ctrl.deviceToAdd(new DeviceModel({'location': {'x': 0, 'y': 0}, 'screen': {'width': 1000, 'height': 1000, 'dpi': 100}}));
                }
              }, [
                "+"
              ])
            );
          else
            toggle = (
              m('div.panel.panel-default', {'style': 'padding: 1em'},
                m('form', [
                  m('input.form-group.form-control', {
                    'placeholder': 'Device name',
                    'oninput': m.withAttr('value', ctrl.deviceToAdd().name),
                    'value': ctrl.deviceToAdd().name() || ''
                  }),
                  m('input.form-group.form-control', {
                    'placeholder': 'Device color',
                    'style': 'background-color: ' + ctrl.deviceToAdd().color(),
                    'oninput': m.withAttr('value', ctrl.deviceToAdd().color),
                    'value': ctrl.deviceToAdd().color() || ''
                  }),
                  m('button.btn.btn-success', {
                    'onclick': function(e) {
                      ctrl.addDevice();
                    }
                  }, [
                    'Create'
                  ])
                ])
              )
            );
          return m('div', {'style': 'position: absolute; bottom: 0.5em; right: 0.5em'}, toggle);
        }
      };

      return Home;
    }());

    window.onload = function() {
      var conn = window.conn = new WebSocket('ws://' + window.location.hostname + ':904/');
      conn.sendObj = function(channel, message) {
        conn.send(JSON.stringify({'channel': channel, 'message': message}));
      };

      var actionHandler = {
        'event-client-updated': function(message) {
          m.startComputation();
          if (app.activeClassroom() && app.activeClassroom()._id() === message.classroom)
          {
            Object.assign(app.activeClassroom().devices[message.index], new DeviceModel(message.device));
          }
          m.endComputation();
        }
      };

      conn.onmessage = function(json) {
        var envelope = JSON.parse(json.data);
        if (envelope.channel in actionHandler) actionHandler[envelope.channel](envelope.message);
      };

      m.route.mode = 'hash';

      var app = window.app = m.mount(document.getElementById('navigation'), App);
      app.addPage({'title': 'Select a classroom', 'href': '/', 'controller': ClassroomSelect});
    };
  </script>
</head>
<body>

<div class="container-fluid">
  <div id="navigation"></div>
  <div id="page"></div>
</div>

</body>
</html>
