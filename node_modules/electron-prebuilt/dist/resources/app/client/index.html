<!DOCTYPE html>
<html>
<head>
  <script src="/lib/mithril.js"></script>
  <script src="/lib/q.min.js"></script>
  <script src="/node_modules/checkerboard/lib/checkerboard.js"></script>
  <script src="/lib/require.js"></script>

  <style>
  .frozen { opacity: 0.25; pointer-events: none; }
  </style>

  <link rel="stylesheet" href="/lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    // apps are implemented very simply.
    // they are stored in /apps/appId. the file icon contains their icon. main.js is a require module
    // that exports start(stm) and onchange(state) functions. apps place their content in the #app div.
    // they can load css using css(url) and javascript using require([url], function(module) {}).
    // apps can find their appId in the state root.

    var stm, conn, associated = false;
    var classrooms = [];

    function css(url) {
      var link = document.createElement("link");
      link.type = "text/css";
      link.rel = "stylesheet";
      link.href = url;
      link.class = "app-css"
      document.getElementsByTagName("head")[0].appendChild(link);
    }

    window.onload = function(e) {
      conn = new WebSocket('ws://' + window.location.hostname + ':904/');

      conn.onopen = function() {
        stm = new Checkerboard(conn);

        m.route.mode = 'hash';
        m.route(document.getElementById('app'), '/', {
          '/': ClassroomSelect,
          ':classroom': DeviceSelect,
          ':classroom/:device': Home
        });

        var savedApp;
        function stateChangeHandler(state) {
          m.startComputation();

          var device = state.devices[m.route.param('device')];

          if (typeof device('app') !== undefined && device('app') !== savedApp) {
            savedApp = device('app')
            require(['/apps/' + device('app') + '/main.js'], function(app) {
              [].slice.call(document.getElementsByClassName('app-css')).forEach(function(link) {
                link.parentNode.removeChild(link);
              });
              var el = document.getElementById('app');
              if (el !== null)
                el.parentNode.removeChild(el);
              el = document.createElement('div');
              el.id = 'app';
              app.startApp(stm, el);
              document.body.appendChild(el);
            });
          }


          m.endComputation();
        };

        m.startComputation();
        stm.on('ready', function(state) {
          if (!associated)
            classrooms = state('classrooms');
          else
            stateChangeHandler(state);
          m.endComputation();
        });

        stm.on('change', stateChangeHandler);
      };
    }

    var ClassroomSelect = {
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a classroom']),
              m('div.list-group', [
                classrooms.map(function(classroom, index) {
                  return m('a.list-group-item', {'href': index, 'config': m.route}, classroom.name)
                })
              ])
            ])
          ])
        );
      }
    };

    var DeviceSelect = {
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a device']),
              m('div.list-group', [
                (classrooms.length !== 0 ? classrooms[m.route.param('classroom')].devices : []).map(function(device, index) {
                  return m('a.list-group-item', {'href': m.route.param('classroom') + '/' + index, 'config': m.route}, device.name)
                })
              ])
            ])
          ])
        );
      }
    };

    var Home = {
      controller: function() {
        var interval = setInterval(function() {
          if (conn.readyState === conn.OPEN) {
            clearInterval(interval);
            conn.send(JSON.stringify({'channel': 'data-associate', 'message': {'classroom': m.route.param('classroom'), 'device': m.route.param('device')}}));
            associated = true;
          }
        }, 100);
      }
    };
  </script>
</head>
<body>
<div id="app"></div>
</body>
</html>
