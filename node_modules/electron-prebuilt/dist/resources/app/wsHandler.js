(function() {
  var ws = require('ws');

  var createServer = function(messageHandler, port) {
    wss = new ws.Server({'port': port});

    var handle = {};
    handle.conns = [];
    handle.sendAll = function (channel, message) {
      for (var i = 0; i < handle.conns.length; i++)
        if (handle.conns[i]) handle.conns[i].send(JSON.stringify({'channel': channel, 'message': message}));
    };

    wss.on('connection', function (wsConn) {
      wsConn.index = handle.conns.length;
      wsConn.heartbeatSent = 0;
      wsConn.heartbeatReceived = 0;
      handle.conns.push(wsConn);

      wsConn.sendObj = function (channel, message) {
        wsConn.send(JSON.stringify({'channel': channel, 'message': message}));
      };

      if ('event-open' in messageHandler)
        messageHandler['event-open'](wsConn, null, null);

      wsConn.on('message', function (json, flags) {
        var envelope = JSON.parse(json);
        if (envelope.channel == 'pong')
          console.log('pong:' + wsConn.heartbeatReceived++);
        else if (envelope.channel in messageHandler)
          messageHandler[envelope.channel](wsConn, envelope.message, flags);
      });

      wsConn.on('close', function (code, json) {
        if ('event-close' in messageHandler)
          messageHandler['event-close'](wsConn, null, null);

        handle.conns[wsConn.index] = undefined;
      });

      var interval = setInterval(function() {
        if (wsConn.readyState == ws.OPEN) {
          wsConn.sendObj('ping');
          console.log('ping');
        }
        if (wsConn.heartbeatSent++ - wsConn.heartbeatReceived >= 3) {
          wsConn.close();
          clearInterval(interval);
        }
      }, 5000);
    });

    return handle;
  };

  module.exports.createServer = createServer;

}());
