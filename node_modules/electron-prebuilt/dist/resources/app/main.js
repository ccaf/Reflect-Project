var app = require('app');

var BrowserWindow = require('browser-window'),
  mainWindow = null;

var Datastore = require('nedb'),
  db = global.db = new Datastore({filename: __dirname + '/embedded.db', autoload: true});

var ports = {
  'http': 1867,
  'wsAdmin': 904,
  'wsClient': 905
};

require('./httpServer').init(ports.http);

var wsClient = null, wsAdmin = null;

function mergeClientState(classroomId, index, mergeState) {
  db.find({'_id': classroomId}, function(err, docs) {
    if (docs.length === 0) return;
    var classroom = docs[0];
    for (var prop in mergeState)
      classroom.devices[index][prop] = mergeState[prop];
    db.update({'_id': classroomId}, classroom);
    wsAdmin.sendAll('event-client-updated', {'classroom': classroomId, 'index': index, 'device': classroom.devices[index]});
  });
}

var wsClientMessageHandler = {
  'event-set-active': function(wsConn, message, flags) {
    wsConn.classroom = message.classroom;
    wsConn.index = message.index;
    mergeClientState(wsConn.classroom, wsConn.index, {'connected': true});
    wsConn.sendObj('event-acknowledge-active');
  },
  'event-close': function(wsConn, message, flags) {
    mergeClientState(wsConn.classroom, wsConn.index, {'connected': false});
  },
  'data-client-state': function(wsConn, message, flags) {
    mergeClientState(wsConn.classroom, wsConn.index, message.state);
  }
};

var wsAdminMessageHandler = {
  'action-load-app': function(wsConn, message, flags) {
    for (var i = 0; i < wsClient.conns.length; i++)
      if (wsClient.conns[i] && wsClient.conns[i].classroom === message.classroom && wsClient.conns[i].index == message.index)
        wsClient.conns[i].sendObj('action-load-app', {'app': message.app});
  },
  'action-get-clients': function(wsConn, message, flags) {
    //wsConn.sendObj('data-get-clients', clients.map(function(client) { client.state = undefined; return client; }));
  }
};

ws = require('./wsHandler');
wsClient = ws.createServer(wsClientMessageHandler, ports.wsClient);
wsAdmin = ws.createServer(wsAdminMessageHandler, ports.wsAdmin);

app.on('ready', function() {
  mainWindow = new BrowserWindow({width: 800, height: 600});
  mainWindow.loadUrl('file://' + __dirname + '/admin/index.html');

  mainWindow.on('closed', function() {
    mainWindow = null;
  });
});

app.on('window-all-closed', function() {
  if (process.platform != 'darwin')
    app.quit();
});
