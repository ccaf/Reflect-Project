<!DOCTYPE html>
<html>
<head>
  <script src="/lib/mithril.js"></script>
  <script src="/lib/q.min.js"></script>
  <script src="/lib/checkerboard.js"></script>
  <script src="/lib/require.js"></script>

  <style>
  .frozen { opacity: 0.25; pointer-events: none; }
  </style>

  <link rel="stylesheet" href="/lib/css/bootstrap.min.css" />

  <script type="text/javascript">
    // apps are implemented very simply.
    // they are stored in /apps/appId. the file icon contains their icon. main.js is a require module
    // that exports start(stm) and onchange(state) functions. apps place their content in the #app div.
    // they can load css using css(url) and javascript using require([url], function(module) {}).
    // apps can find their appId in the state root.

    var stm, conn, app, appId;

    function css(url) {
      var link = document.createElement("link");
      link.type = "text/css";
      link.rel = "stylesheet";
      link.href = url;
      document.getElementsByTagName("head")[0].appendChild(link);
    }

    window.onload = function(e) {
      conn = new WebSocket('ws://' + window.location.hostname + ':904/');

      conn.onopen = function() {
        stm = new SharedTransactionalMemory(conn);

        stm.onready = function(state) {
          appId = state.appId();
          require(['/apps/' + state.appId() + '/main.js'], function(main) {
            app = main;
            main.start(stm);
          });

          stm.sync(100);

          if ('frozen' in state.self) {
            if (state.self.frozen())
              document.body.classList.add('frozen');
            else
              document.body.classList.remove('frozen');
          }
        }

        stm.onchange = function(state) {
          if ('appId' in state && state.appId() !== appId)
            location.reload();
          else {
            if ('frozen' in state.self) {
              if (state.self.frozen())
                document.body.classList.add('frozen');
              else
                document.body.classList.remove('frozen');
            }

            app.onchange(state);
          }
        };
      };

      var actionHandler = window.actionHandler = {
        'ping': function() {
          conn.sendObj('pong');
        }
      };

      conn.onmessage = function(json) {
        var envelope = JSON.parse(json.data);
        if (envelope.channel in actionHandler)
          actionHandler[envelope.channel](envelope.message);
      };

      m.route.mode = 'hash';
      m.route(document.getElementById('app'), '/', {
        '/': ClassroomSelect,
        ':classroom': DeviceSelect,
        ':classroom/:id': Home
      });
    }

    var ClassroomSelect = {
      'controller': function(args) {
        return {
          'classrooms': m.request({'method': 'GET', 'url': '/api/classroom'})
        };
      },
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a classroom']),
              m('div.list-group', [
                ctrl.classrooms().map(function(classroom) {
                  return m('a.list-group-item', {'href': classroom._id, 'config': m.route}, classroom.name)
                })
              ])
            ])
          ])
        );
      }
    };

    var DeviceSelect = {
      'controller': function(args) {
        return {
          'devices': m.request({'method': 'GET', 'url': '/api/classroom/' + m.route.param('classroom') + '/device'})
        };
      },
      'view': function(ctrl) {
        return (
          m('div.row', [
            m('div.col-md-4.col-md-offset-4', [
              m('h4', ['Select a device']),
              m('div.list-group', [
                ctrl.devices().map(function(device) {
                  return m('a.list-group-item', {'href': m.route.param('classroom') + '/' + device._id, 'config': m.route}, device.name)
                })
              ])
            ])
          ])
        );
      }
    };

    var Home = {
      controller: function() {
        var interval = setInterval(function() {
          if (conn.readyState === conn.OPEN) {
            clearInterval(interval);

            conn.send(JSON.stringify({'channel': 'data-associate', 'message': {'classroom': m.route.param('classroom'), '_id': m.route.param('id')}}));
          }
        }, 100);
      }
    };
  </script>
</head>
<body>
<div id="app"></div>
</body>
</html>
