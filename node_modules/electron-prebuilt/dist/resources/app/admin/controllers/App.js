var App = (function(){
  var App = {
    'controller': function() {
      var pages = m.prop([]);

      var addPage = function(page) {
        m.startComputation();

        if (page instanceof Array)
          for (var i = 0; i < page.length; i++)
            pages().push(page[i]);
        else if (page !== null && typeof page !== 'undefined')
          pages().push(page);

        m.route(document.getElementById('page'), '/', pages().reduce(function(acc, cur) {
            return acc[cur.href] = cur.controller, acc;
          }, {}));
        m.endComputation();
      };

      var removePage = function(href) {
        pages().splice(pages().map(function(page) { return page.href; }).indexOf(href), 1);
        addPage(null);
      };

      var activeClassroom = m.prop();

      var setActiveClassroom = function(classroomId) {
        ClassroomModel.get({'_id': classroomId}).then(function(classroom) {
          activeClassroom(classroom);
        });
        removePage('/');
        addPage([
          {'title': 'Home', 'href': '/', 'controller': Home},
          {'title': 'Devices', 'href': '/devices'},
          {'title': 'Users', 'href': '/users'},
          {'title': 'Apps', 'href': '/apps'}
        ]);
        m.route('/');
      };

      return {
        'pages': pages,
        'activeClassroom': activeClassroom,
        'setActiveClassroom': setActiveClassroom,
        'addPage': addPage,
        'removePage': removePage
      };
    },
    'view': function(ctrl) {
      return (
        m('div', [
          m('ul', {
            'class': 'nav nav-tabs nav-justified'
          }, ctrl.pages().map(function(page) {
            return (
              m('li', {
                'class': (m.route() === page.href ? 'active' : '')
              }, [
                m('a', {'href': page.href, 'config': m.route}, page.title)
              ])
            );
          })),
          m('br')
        ])
      );
    }
  };

  return App;
}());
